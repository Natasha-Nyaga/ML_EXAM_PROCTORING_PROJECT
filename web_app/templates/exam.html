{% extends "base.html" %}
{% block content %}
<div class="exam-container">
  <h2>Online Examination</h2>

  <!-- Exam Instructions -->
  <div class="instructions">
    <h3>Instructions:</h3>
    <ul>
      <li>You have <b>30 minutes</b> to complete this exam.</li>
      <li>Do not switch tabs or attempt to open external resources.</li>
      <li>Suspicious activity may be flagged in real time.</li>
      <li>Click <b>Submit Exam</b> once you are done.</li>
    </ul>
  </div>

  <!-- Timer -->
  <div class="timer-box">
    <span>Time Remaining: </span>
    <span id="timer">30:00</span>
  </div>

  <!-- Exam Questions -->
  <form id="examForm">
    <div class="question">
      <p><b>Q1.</b> Which of the following is a machine learning algorithm?</p>
      <label><input type="radio" name="q1" value="Decision Tree"> Decision Tree</label><br>
      <label><input type="radio" name="q1" value="HTTP"> HTTP</label>
    </div>

    <div class="question">
      <p><b>Q2.</b> In cybersecurity, what does “phishing” mean?</p>
      <textarea id="q2" name="q2" placeholder="Type your answer here..." rows="4"></textarea>
    </div>

    <div class="question">
      <p><b>Q3.</b> Which database is commonly used with Python Flask?</p>
      <label><input type="radio" name="q3" value="PostgreSQL"> PostgreSQL</label><br>
      <label><input type="radio" name="q3" value="Excel"> Excel</label>
    </div>

    <button type="submit" id="submitExambtn" class="btn">Submit Exam</button>
  </form>

  <!-- Live Monitoring Status -->
  <div id="exam-status" class="result-box">Exam monitoring active...</div>
</div>

<style>
.exam-container {
  max-width: 800px;
  margin: auto;
  padding: 20px;
}
.instructions {
  background: #000000;
  padding: 15px;
  margin-bottom: 20px;
  border-radius: 8px;
}
.timer-box {
  font-size: 18px;
  font-weight: bold;
  margin-bottom: 20px;
  color: #d9534f;
}
.question {
  margin-bottom: 20px;
  padding: 15px;
  background: #000000;
  border-radius: 8px;
}
.btn {
  background: #007bff;
  color: white;
  padding: 10px 20px;
  border-radius: 6px;
  border: none;
}
.result-box {
  margin-top: 20px;
  padding: 10px;
  background: rgb(36, 122, 57);
  border-radius: 6px;
  color: white;
}
</style>

<script>
// Timer (30 mins countdown)
let timeLeft = 30 * 60; // seconds
const timerEl = document.getElementById("timer");

function updateTimer() {
  let minutes = Math.floor(timeLeft / 60);
  let seconds = timeLeft % 60;
  timerEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
  if (timeLeft > 0) {
    timeLeft--;
  } else {
    alert("Time is up! Submitting your exam.");
    document.getElementById("examForm").submit();
  }
}
setInterval(updateTimer, 1000);

// --- Activity Monitoring (keystrokes + mouse) ---
let keystrokes = [];
let mouseEvents = [];
let lastMouseTime = null;

document.addEventListener('keydown', e => {
  keystrokes.push({type:'down', key:e.key, ts: Date.now()});
});
document.addEventListener('keyup', e => {
  keystrokes.push({type:'up', key:e.key, ts: Date.now()});
});

document.addEventListener('mousemove', e => {
  const ts = Date.now();
  if (lastMouseTime) {
    mouseEvents.push({type:'move', x:e.clientX, y:e.clientY, dt: ts - lastMouseTime, ts});
  }
  lastMouseTime = ts;
});
document.addEventListener('click', e => {
  mouseEvents.push({type:'click', x:e.clientX, y:e.clientY, ts: Date.now()});
});

// Send monitoring data every 1 min
async function sendActivity() {
  const payload = {
    student_id: "student123",
    keystrokes: keystrokes,
    mouse: mouseEvents,
    timestamp: Date.now()
  };

  try {
    const r = await fetch('/api/exam/monitor', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const data = await r.json();
    document.getElementById('exam-status').innerText =
      `Last check (${new Date().toLocaleTimeString()}): ${data.status}`;

    keystrokes = [];
    mouseEvents = [];
  } catch (err) {
    document.getElementById('exam-status').innerText = 'Error sending activity';
  }
}
setInterval(sendActivity, 60 * 1000);

// Handle exam submission
document.getElementById("submitExambtn").addEventListener("click", async (e) => {
  e.preventDefault();

  const answers = {
    q1: (document.querySelector('input[name="q1"]:checked') || {}).value || null,
    q2: document.getElementById("q2").value || null,
    q3: (document.querySelector('input[name="q3"]:checked') || {}).value || null
  };

  try {
    const res = await fetch("/api/exam/submit", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ student_id: "student123", answers })
    });

    const data = await res.json();

    if (data.redirect) {
      window.location.href = data.redirect;
    } else {
      alert("Submission failed: " + (data.error || "Unknown error"));
    }
  } catch (err) {
    alert("Error submitting exam: " + err);
  }
});
</script>

<!-- Socket.IO for real-time flagging -->
<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<script>
  const socket = io();

  socket.on("connect", () => {
    console.log("Connected to server for monitoring");
  });

  socket.on("cheating_flag", (data) => {
    console.log("Flag received:", data);
    document.getElementById("exam-status").innerText =
      `⚠️ Cheating flag at ${new Date().toLocaleTimeString()}: ${data.message}`;
    alert("⚠️ Cheating flag: " + data.message);
  });
</script>
{% endblock %}
